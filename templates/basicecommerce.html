<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>E-commerce b√°sico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">üì¶ E-commerce b√°sico</h1>

    <!-- ============ FORMULARIO PRODUCTO ============ -->
    <div class="card mb-4">
      <div class="card-header">Agregar producto</div>
      <div class="card-body">
        <form id="productForm">
          <input type="hidden" id="productId">
          <div class="row g-3">
            <div class="col-md-3">
              <input type="text" id="nombre" class="form-control" placeholder="Nombre" required>
            </div>
            <div class="col-md-3">
              <input type="text" id="descripcion" class="form-control" placeholder="Descripci√≥n">
            </div>
            <div class="col-md-2">
              <input type="number" id="precio" class="form-control" placeholder="Precio" step="0.01" required>
            </div>
            <div class="col-md-2">
              <input type="number" id="stock" class="form-control" placeholder="Stock" required>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary">Guardar</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ============ LISTADO PRODUCTOS ============ -->
    <h3 class="mb-3">Productos</h3>
    <div class="row" id="productList"></div>

    <!-- ============ FORMULARIO PEDIDO ============ -->
    <div class="card mt-5">
      <div class="card-header">Crear Pedido</div>
      <div class="card-body">
        <form id="orderForm">
          <div id="orderItems"></div>
          <button type="button" class="btn btn-secondary my-2" onclick="addOrderItem()">‚ûï Agregar producto</button>
          <button type="submit" class="btn btn-success">Crear Pedido</button>
        </form>
      </div>
    </div>

  </div>

  <script>
    const API_URL = "http://localhost:8080/api"; // ‚ö†Ô∏è Ajusta la URL de tu backend

    // ================== PRODUCTOS ==================
    document.addEventListener("DOMContentLoaded", () => {
      loadProducts();
      addOrderItem(); // Agregar primer producto al formulario de pedido
    });

    // Crear/editar producto
    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = document.getElementById("productId").value;
      const nombre = document.getElementById("nombre").value;
      const descripcion = document.getElementById("descripcion").value;
      const precio = parseFloat(document.getElementById("precio").value);
      const stock = parseInt(document.getElementById("stock").value);

      const product = { nombre, descripcion, precio, stock };

      let res;
      if (id) {
        res = await fetch(`${API_URL}/productos/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(product),
        });
      } else {
        res = await fetch(`${API_URL}/productos`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(product),
        });
      }

      if (res.ok) {
        document.getElementById("productForm").reset();
        document.getElementById("productId").value = "";
        loadProducts();
      } else {
        alert("‚ùå Error al guardar producto");
      }
    });

    // Cargar lista de productos
    async function loadProducts() {
      try {
        const res = await fetch(`${API_URL}/productos`);
        const products = await res.json();

        const list = document.getElementById("productList");
        list.innerHTML = "";

        products.forEach((p) => {
          const card = document.createElement("div");
          card.className = "col-md-4 mb-3";
          card.innerHTML = `
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <h5 class="card-title">${p.nombre}</h5>
                <p class="card-text">${p.descripcion || "Sin descripci√≥n"}</p>
                <p><strong>Precio:</strong> $${p.precio}</p>
                <p><strong>Stock:</strong> ${p.stock}</p>
                <button class="btn btn-sm btn-warning me-2" onclick="editProduct('${p.id}', '${p.nombre}', '${p.descripcion}', ${p.precio}, ${p.stock})">‚úèÔ∏è Editar</button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">üóëÔ∏è Eliminar</button>
              </div>
            </div>
          `;
          list.appendChild(card);
        });
      } catch (error) {
        console.error("Error cargando productos:", error);
      }
    }

    // Editar producto
    function editProduct(id, nombre, descripcion, precio, stock) {
      document.getElementById("productId").value = id;
      document.getElementById("nombre").value = nombre;
      document.getElementById("descripcion").value = descripcion;
      document.getElementById("precio").value = precio;
      document.getElementById("stock").value = stock;
    }

    // Eliminar producto
    async function deleteProduct(id) {
      if (!confirm("¬øSeguro que deseas eliminar este producto?")) return;
      const res = await fetch(`${API_URL}/productos/${id}`, { method: "DELETE" });
      if (res.ok) {
        loadProducts();
      } else {
        alert("‚ùå Error al eliminar producto");
      }
    }

    // ================== PEDIDOS ==================
    document.getElementById("orderForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const items = [];
      document.querySelectorAll(".order-item").forEach((item) => {
        const productoId = parseInt(item.querySelector(".productoId").value);
        const cantidad = parseInt(item.querySelector(".cantidad").value);
        if (productoId && cantidad > 0) {
          items.push({ productoId, cantidad });
        }
      });

      if (items.length === 0) {
        alert("‚ùå Debes agregar al menos un producto al pedido");
        return;
      }

      const res = await fetch(`${API_URL}/pedidos`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items }),
      });

      if (res.ok) {
        alert("‚úÖ Pedido creado con √©xito");
        document.getElementById("orderForm").reset();
        document.getElementById("orderItems").innerHTML = "";
        addOrderItem();
      } else {
        alert("‚ùå Error al crear pedido");
      }
    });

    // Agregar campos al formulario de pedido
    async function addOrderItem() {
      const res = await fetch(`${API_URL}/productos`);
      const products = await res.json();

      const container = document.getElementById("orderItems");
      const div = document.createElement("div");
      div.className = "order-item row g-2 mb-2";

      div.innerHTML = `
        <div class="col-md-6">
          <select class="form-select productoId" required>
            <option value="">Selecciona producto</option>
            ${products.map(p => `<option value="${p.id}">${p.nombre}</option>`).join("")}
          </select>
        </div>
        <div class="col-md-4">
          <input type="number" class="form-control cantidad" placeholder="Cantidad" min="1" required>
        </div>
        <div class="col-md-2 d-grid">
          <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove()">‚ùå</button>
        </div>
      `;

      container.appendChild(div);
    }
  </script>
</body>
</html>
